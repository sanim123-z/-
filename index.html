<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ù†Ø­Ùˆ Pro - Ø§Ù„ØµÙ†Ø¯Ù‚Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              rubik: ['Rubik', 'sans-serif'],
            }
          }
        }
      }
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;800;900&display=swap" rel="stylesheet">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Libraries -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      body {
        font-family: 'Rubik', sans-serif;
        background-color: #ffffff;
        min-height: 100vh;
        margin: 0;
        overflow-x: hidden;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #dcfce7;
        border-radius: 10px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #374151;
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const { motion, AnimatePresence } = window.Motion;
        const { jsPDF } = window.jspdf;

        // --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ÙØ§ØªÙŠØ­ ---
        const API_KEY = "AIzaSyCwhxO68n6REe4HUMgiYjt8AQ80SAxlHkw";

        const MODEL_LIST = [
            "gemini-3-flash-preview", 
            "gemini-2.0-flash-exp",
            "gemini-1.5-flash",
            "gemini-1.5-pro"
        ];

        const THEME_COLORS = [
            'green', 'emerald', 'teal', 'cyan',
            'sky', 'blue', 'indigo', 'violet',
            'purple', 'fuchsia', 'pink', 'rose',
            'red', 'orange', 'amber', 'lime'
        ];

        // --- 2. Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø°ÙƒÙŠ (SYSTEM PROMPT) - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø°Ø±ÙŠ ---
        const SYSTEM_PROMPT = `
        Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„Ù†Ø­Ùˆ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØªØ­Ø¯ÙŠØ¯Ø§Ù‹ ÙÙŠ "Ø§Ù„ØµÙ†Ø¯Ù‚Ø©" (Box Analysis).
        
        Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØµØ§Ø±Ù…Ø© Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰):
        
        1. **Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 0 (Ø§Ù„Ø¬Ø°Ø±):** Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù…Ù„Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø¬Ù…Ù„Ø© ÙØ¹Ù„ÙŠØ© Ø¨Ø³ÙŠØ·Ø©ØŒ Ø¬Ù…Ù„Ø© Ø§Ø³Ù…ÙŠØ© Ù…Ø±ÙƒØ¨Ø©).
        
        2. **Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1 (Ø§Ù„ÙˆØ¸Ø§Ø¦Ù):** 
           - ÙŠØ¬Ø¨ Ø°ÙƒØ± Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù†Ø­ÙˆÙŠØ© (ÙØ§Ø¹Ù„ØŒ Ù…ÙØ¹ÙˆÙ„ Ø¨Ù‡ØŒ Ø®Ø¨Ø±ØŒ Ø¥Ù„Ø®).
           - **Ù‡Ø§Ù…:** Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ø±ÙƒØ¨Ø§Ù‹ØŒ ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø©: "Ø§Ù„ÙˆØ¸ÙŠÙØ© : Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ¨" (Ù…Ø«Ù„Ø§Ù‹: "ÙØ§Ø¹Ù„ : Ù…Ø±ÙƒØ¨ Ù†Ø¹ØªÙŠ").
           - Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ±Ø¯Ø§Ù‹ØŒ Ù†ÙƒØªØ¨ Ø§Ù„ÙˆØ¸ÙŠÙØ© ÙÙ‚Ø·.

        3. **Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2 (Ø§Ù„ØªÙÙƒÙŠÙƒ):**
           - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1 Ù…Ø±ÙƒØ¨Ø§Ù‹ØŒ ÙŠØ¬Ø¨ ØªÙÙƒÙŠÙƒÙ‡ Ù‡Ù†Ø§ (Ù…Ø«Ù„Ø§Ù‹: Ù…Ù†Ø¹ÙˆØªØŒ Ù†Ø¹Øª / Ø¬Ø§Ø±ØŒ Ù…Ø¬Ø±ÙˆØ±).
           - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ø­Ø¯ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ø±ÙƒØ¨ Ù‡Ùˆ Ø£ÙŠØ¶Ø§Ù‹ Ù…Ø±ÙƒØ¨ (ØªØ¯Ø§Ø®Ù„)ØŒ Ù†ÙƒØ±Ø± Ù†ÙØ³ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: "Ø§Ù„ÙˆØ¸ÙŠÙØ© : Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ¨".

        4. **Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø®ÙŠØ± (Ø§Ù„Ø£ÙˆØ±Ø§Ù‚):** Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ø¬Ù…Ù„Ø©.

        ØªÙ†Ø³ÙŠÙ‚ JSON Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
        {
          "label": "Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù…Ù„Ø©",
          "children": [
            {
              "label": "Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ø£Ùˆ Ø§Ù„ÙˆØ¸ÙŠÙØ© : Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ¨)",
              "isLeaf": false,
              "children": [
                 { "label": "Ø§Ù„ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø§Ù„Ø¬Ø²Ø¡", "isLeaf": true } 
              ]
            }
          ]
        }
        
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…ØµÙÙˆÙØ© children ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ù…Ù„Ø© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±.
        `;

        // --- 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ---
        const analyzeSentence = async (text) => {
            let lastError = null;
            for (const model of MODEL_LIST) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: SYSTEM_PROMPT },
                                    { text: `Ø­Ù„Ù„ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ØµÙ†Ø¯Ù‚ÙŠØ§Ù‹: "${text}"` }
                                ]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || 'Server Error');
                    }

                    const data = await response.json();
                    let jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("Empty response");
                    const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) jsonText = jsonMatch[0];
                    return JSON.parse(jsonText);

                } catch (error) {
                    console.warn(`Failed with model ${model}:`, error);
                    lastError = error;
                }
            }
            throw lastError || new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙˆØ§Ø¯Ù…");
        };

        // --- Icons ---
        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Back: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>,
            PDF: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            EmptyIllustration: ({color = "green", isDark = false}) => (
                <svg width="220" height="220" viewBox="0 0 220 220" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="110" cy="110" r="90" className={`fill-${color}-500`} style={{ opacity: isDark ? 0.05 : 0.03, filter: 'blur(40px)' }} />
                    <rect x="75" y="60" width="70" height="60" rx="8" className={`fill-white dark:fill-gray-800 stroke-${color}-500`} strokeWidth="3" />
                    <line x1="85" y1="80" x2="135" y2="80" className={`stroke-${color}-200`} strokeWidth="4" strokeLinecap="round" />
                    <line x1="85" y1="95" x2="115" y2="95" className={`stroke-${color}-200`} strokeWidth="4" strokeLinecap="round" />
                    <rect x="35" y="140" width="60" height="40" rx="8" className={`fill-${color}-100 dark:fill-${color}-900 stroke-${color}-400`} strokeWidth="2" />
                    <rect x="125" y="140" width="60" height="40" rx="8" className={`fill-${color}-500 stroke-${color}-600`} strokeWidth="2" />
                    <path d="M110 120 V 140" className={`stroke-${color}-300`} strokeWidth="2" strokeDasharray="4 4" />
                    <path d="M110 130 H 65 V 140" className={`stroke-${color}-300`} strokeWidth="2" strokeDasharray="4 4" />
                    <path d="M110 130 H 155 V 140" className={`stroke-${color}-300`} strokeWidth="2" strokeDasharray="4 4" />
                </svg>
            )
        };

        // --- Components ---

        const Button3D = ({ onClick, children, variant = 'primary', disabled = false, className = '', color = 'green' }) => {
            const baseStyle = "w-full py-4 rounded-2xl text-xl font-black font-rubik transition-all transform active:translate-y-1 active:border-b-0 border-b-4 flex justify-center items-center gap-2 shadow-sm";
            const variants = {
                primary: `bg-${color}-500 text-white border-${color}-700 hover:bg-${color}-600`,
                secondary: "bg-white text-gray-700 border-gray-200 hover:bg-gray-50 hover:border-gray-300 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 dark:hover:bg-gray-700",
                disabled: "bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed dark:bg-gray-800 dark:border-gray-700 dark:text-gray-600"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${disabled ? variants.disabled : variants[variant]} ${className}`}>
                {children}
                </button>
            );
        };

        // ğŸ’¡ Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø£Ù‚ØµÙ‰ Ø¹Ù…Ù‚ Ù„ÙƒÙ„ Ø¹Ù‚Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
        const calculateDepth = (node) => {
            if (!node.children || node.children.length === 0) return 1;
            return 1 + Math.max(...node.children.map(calculateDepth));
        };

        // --- SandaqaChart ---
        const SandaqaChart = ({ node, themeColor = 'green', forcePrintMode = false, isDarkMode = false }) => {
            
            const renderNode = (currentNode, currentDepth) => {
                const isLeaf = currentNode.isLeaf;
                
                const borderColorClass = forcePrintMode ? "border-black" : `border-${themeColor}-500`;
                
                const getLabelStyle = () => {
                    if (isLeaf) return ""; 
                    if (forcePrintMode) return "bg-white text-black border-t-2 border-black";
                    if (currentDepth === 0) {
                        return isDarkMode 
                            ? `bg-gradient-to-b from-${themeColor}-900 to-${themeColor}-800 text-white border-t border-${themeColor}-500/30`
                            : `bg-gradient-to-b from-${themeColor}-50 to-${themeColor}-100 text-${themeColor}-800 border-t border-${themeColor}-200`;
                    }
                    return isDarkMode ? `bg-slate-800 text-white` : `bg-gray-50 text-gray-800`;
                };

                const getBoxStyle = () => {
                    if (forcePrintMode) return "bg-white text-black border-black";
                    if (isLeaf) return "bg-white text-gray-900";
                    return isDarkMode ? `bg-slate-900 text-white` : `bg-white text-gray-900`;
                };

                // --- Ø§Ù„Ø­Ø§Ù„Ø© 1: Ø§Ù„ÙƒÙ„Ù…Ø© (Ø§Ù„ÙˆØ±Ù‚Ø©) ---
                if (isLeaf) {
                    return (
                        <div className={`flex flex-col flex-1 border-r-2 ${borderColorClass} first:border-r-0 min-w-[100px]`}>
                            <div className={`h-[80px] flex items-center justify-center p-3 transition-colors bg-white border-b-2 ${borderColorClass}`}>
                                <span className="text-2xl md:text-3xl font-black font-rubik text-black text-center leading-tight break-words w-full">
                                    {currentNode.label}
                                </span>
                            </div>
                            <div className={`flex-1 ${getBoxStyle()}`}></div>
                        </div>
                    );
                }

                // --- Ø§Ù„Ø­Ø§Ù„Ø© 2: Ø§Ù„Ø¹Ù‚Ø¯Ø© (Ø§Ù„ÙˆØ¸ÙŠÙØ©/Ø§Ù„Ø¬Ù…Ù„Ø©) ---
                return (
                    <div className={`flex flex-col flex-1 ${currentDepth === 0 ? `border-2 ${borderColorClass} rounded-xl overflow-hidden shadow-sm` : `border-r-2 ${borderColorClass} first:border-r-0`} ${getBoxStyle()}`}>
                        
                        {/* 1. Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ (Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©) - ÙŠØ¸Ù‡Ø±ÙˆÙ† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */}
                        <div className="flex flex-row items-stretch w-full flex-1">
                            {currentNode.children?.map((child, idx) => (
                                renderNode(child, currentDepth + 1)
                            ))}
                        </div>

                        {/* 2. Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù…Ù„Ø©) - ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */}
                        <div className={`border-t-2 ${borderColorClass} w-full flex-col flex items-center justify-center p-2 text-center transition-colors min-h-[60px] ${getLabelStyle()}`}>
                            <span className={`${currentDepth === 0 ? 'text-xl md:text-2xl font-black py-2' : 'text-base md:text-lg font-bold'} font-rubik leading-tight px-1`}>
                                {currentNode.label}
                            </span>
                        </div>
                    </div>
                );
            };

            return renderNode(node, 0);
        };

        // --- Main App Logic ---

        const App = () => {
            const [view, setView] = useState('home');
            const [inputText, setInputText] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const [forcePrintMode, setForcePrintMode] = useState(false);
            const [showExportMenu, setShowExportMenu] = useState(false);
            
            const [darkMode, setDarkMode] = useState(() => {
                try { return localStorage.getItem('sandaqa_theme_mode') === 'dark'; } catch { return false; }
            });
            const [themeColor, setThemeColor] = useState(() => {
                try { return localStorage.getItem('sandaqa_theme_color') || 'green'; } catch { return 'green'; }
            });
            const [history, setHistory] = useState(() => {
                try { return JSON.parse(localStorage.getItem('grammar_history') || '[]'); } catch { return []; }
            });

            const chartRef = useRef(null);

            useEffect(() => { localStorage.setItem('grammar_history', JSON.stringify(history)); }, [history]);
            useEffect(() => { localStorage.setItem('sandaqa_theme_mode', darkMode ? 'dark' : 'light'); }, [darkMode]);
            useEffect(() => { localStorage.setItem('sandaqa_theme_color', themeColor); }, [themeColor]);

            const handleAnalyze = async () => {
                if (!inputText.trim()) return;
                setLoading(true);
                setError(null);
                try {
                    const rootNode = await analyzeSentence(inputText);
                    const newResult = { text: inputText, root: rootNode, timestamp: Date.now() };
                    setResult(newResult);
                    setHistory(prev => [newResult, ...prev]);
                    setView('result');
                } catch (err) {
                    setError('Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                } finally { setLoading(false); }
            };

            const captureImage = async () => {
                if (!chartRef.current) return null;
                const canvas = await window.html2canvas(chartRef.current, {
                    backgroundColor: "#ffffff",
                    scale: 3,
                    useCORS: true,
                    logging: false
                });
                return { dataUrl: canvas.toDataURL("image/png"), width: canvas.width, height: canvas.height };
            };

            const handleExport = async (format) => {
                if (!result) return;
                setShowExportMenu(false);
                setForcePrintMode(true);
                setTimeout(async () => {
                    try {
                        const capture = await captureImage();
                        if (capture) {
                            const fileName = `nahw-${Date.now()}`;
                            if (format === 'png') {
                                const link = document.createElement('a');
                                link.download = `${fileName}.png`;
                                link.href = capture.dataUrl;
                                link.click();
                            } else if (format === 'pdf') {
                                const isLandscape = capture.width > capture.height;
                                const pdf = new jsPDF({
                                    orientation: isLandscape ? 'landscape' : 'portrait',
                                    unit: 'px',
                                    format: [capture.width * 0.264, capture.height * 0.264]
                                });
                                pdf.addImage(capture.dataUrl, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                                pdf.save(`${fileName}.pdf`);
                            }
                        }
                    } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±"); } 
                    finally { setForcePrintMode(false); }
                }, 100);
            };

            return (
                <div className={`${darkMode ? 'dark' : ''} h-full min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300 font-rubik overflow-hidden`}>
                <div className="min-h-screen flex flex-col max-w-md mx-auto relative shadow-2xl border-x border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 transition-colors">
                    
                    {view !== 'input' && (
                    <header className="px-5 py-3 flex justify-between items-center bg-white dark:bg-gray-900 border-b-2 border-gray-100 dark:border-gray-800 z-10 sticky top-0 transition-colors">
                        <div className="w-full flex justify-between items-center relative">
                        <div className="flex items-center gap-2">
                            <h1 className={`text-2xl font-black text-${themeColor}-500 font-rubik transition-colors`}>Ù†Ø­Ùˆ</h1>
                        </div>
                        <span className="text-gray-400 dark:text-gray-500 font-black font-rubik uppercase tracking-widest text-xs">
                            {view === 'home' ? 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : view === 'settings' ? 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' : 'Ø§Ù„Ù†ØªÙŠØ¬Ø©'}
                        </span>
                        <div className="flex items-center gap-2">
                            {view !== 'home' && view !== 'settings' && (
                            <button onClick={() => setView('home')} className="text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl p-2 transition-colors"><Icons.Back /></button>
                            )}
                            <button onClick={() => setView('settings')} className={`p-2 rounded-xl text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors ${view === 'settings' ? `text-${themeColor}-500 bg-${themeColor}-50 dark:bg-gray-800` : ''}`}>
                            <Icons.Settings />
                            </button>
                        </div>
                        </div>
                    </header>
                    )}

                    <div className="flex-1 relative flex flex-col overflow-hidden">
                    <AnimatePresence mode="wait">
                        {view === 'home' && (
                        <motion.div key="home" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="h-full flex flex-col relative pb-24 overflow-y-auto">
                            {history.length === 0 ? (
                            <div className="flex-1 flex flex-col items-center justify-center p-10 text-center">
                                <div className="mb-8 transform hover:scale-105 transition-transform">
                                <Icons.EmptyIllustration color={themeColor} isDark={darkMode} />
                                </div>
                                <h2 className="text-2xl font-black text-gray-800 dark:text-gray-100 mb-3 transition-colors font-rubik">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ù†Ø­ÙˆÙŠØ©!</h2>
                                <p className="text-gray-500 dark:text-gray-400 text-lg font-medium font-rubik leading-relaxed max-w-[280px] transition-colors">Ø£Ø¯Ø®Ù„ Ø¬Ù…Ù„ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø§Ù„Ø¢Ù† Ù„Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© Ø§Ù„ØµÙ†Ø¯Ù‚Ø©.</p>
                            </div>
                            ) : (
                            <div className="p-4 space-y-3">
                                {history.map((item, idx) => (
                                <motion.div key={item.timestamp} initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: idx * 0.05 }} onClick={() => { setResult(item); setView('result'); }} className={`bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 hover:border-${themeColor}-300 dark:hover:border-${themeColor}-500 p-4 rounded-3xl flex justify-between items-center cursor-pointer group transition-all shadow-sm`}>
                                    <div className="flex items-center gap-4 overflow-hidden">
                                    <div className={`w-12 h-12 bg-${themeColor}-50 dark:bg-${themeColor}-900/20 rounded-2xl flex items-center justify-center text-${themeColor}-500 font-black text-xl border-b-4 border-${themeColor}-100 dark:border-${themeColor}-800/50 shrink-0`}>Ù†</div>
                                    <div className="flex flex-col overflow-hidden">
                                        <h4 className="font-rubik font-bold text-gray-800 dark:text-gray-200 text-lg truncate text-right" dir="rtl">{item.text}</h4>
                                        <span className="text-xs text-gray-400 font-bold font-rubik text-right">{new Date(item.timestamp).toLocaleDateString('ar-EG')}</span>
                                    </div>
                                    </div>
                                </motion.div>
                                ))}
                            </div>
                            )}
                            <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-t border-gray-100 dark:border-gray-800 z-20 max-w-md mx-auto">
                            <Button3D onClick={() => { setInputText(''); setError(null); setView('input'); }} color={themeColor}>
                                <Icons.Plus />
                                <span>ØªØ­Ù„ÙŠÙ„ Ø¬Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                            </Button3D>
                            </div>
                        </motion.div>
                        )}

                        {view === 'settings' && (
                        <motion.div key="settings" initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0 }} className="h-full bg-gray-50 dark:bg-gray-900 flex flex-col p-6 overflow-y-auto">
                            <div className="mb-6">
                            <h3 className="text-xs font-black text-gray-400 dark:text-gray-500 mb-4 text-center uppercase tracking-widest font-rubik">Ø§Ù„Ù…Ø¸Ù‡Ø±</h3>
                            <div className="bg-white dark:bg-gray-800 rounded-3xl p-2 flex border border-gray-100 dark:border-gray-700 shadow-sm">
                                <button onClick={() => setDarkMode(false)} className={`flex-1 py-3 rounded-2xl flex items-center justify-center gap-2 font-bold transition-all font-rubik ${!darkMode ? `bg-${themeColor}-100 text-${themeColor}-700 shadow-sm ring-1 ring-${themeColor}-200` : 'text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'}`}><Icons.Sun /><span>Ù†Ù‡Ø§Ø±ÙŠ</span></button>
                                <button onClick={() => setDarkMode(true)} className={`flex-1 py-3 rounded-2xl flex items-center justify-center gap-2 font-bold transition-all font-rubik ${darkMode ? `bg-slate-700 text-white shadow-sm ring-1 ring-slate-600` : 'text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'}`}><Icons.Moon /><span>Ù„ÙŠÙ„ÙŠ</span></button>
                            </div>
                            </div>
                            <div className="mb-8">
                            <h3 className="text-xs font-black text-gray-400 dark:text-gray-500 mb-4 text-center uppercase tracking-widest font-rubik">ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ù…Ø©</h3>
                            <div className="grid grid-cols-4 gap-3 p-3 bg-white dark:bg-gray-800 rounded-3xl shadow-inner border border-gray-100 dark:border-gray-700">
                                {THEME_COLORS.map((color) => (
                                <button key={color} onClick={() => setThemeColor(color)} className={`aspect-square rounded-2xl flex items-center justify-center transition-all bg-${color}-500 border-b-4 border-${color}-700 ${themeColor === color ? 'scale-110 shadow-lg ring-2 ring-white dark:ring-gray-600' : 'opacity-70 hover:opacity-100'}`}>
                                    {themeColor === color && <div className="text-white"><Icons.Check /></div>}
                                </button>
                                ))}
                            </div>
                            </div>
                            <div className="mt-auto">
                            <Button3D onClick={() => setView('home')} variant="secondary" color={themeColor}>Ø¹ÙˆØ¯Ø©</Button3D>
                            </div>
                        </motion.div>
                        )}

                        {view === 'input' && (
                        <motion.div key="input" initial={{ opacity: 0, y: 50 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 50 }} className="h-full bg-white dark:bg-gray-900 flex flex-col p-6">
                            <div className="flex justify-between items-center mb-10">
                            <button onClick={() => setView('home')} className="text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 p-2 rounded-xl transition-colors"><Icons.Back /></button>
                            <div className="h-2 flex-1 mx-6 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden"><div className={`h-full bg-${themeColor}-500 w-full transition-all`}></div></div>
                            <div className="w-8"></div>
                            </div>
                            <h2 className="text-2xl font-black text-gray-800 dark:text-gray-100 text-center mb-6 transition-colors font-rubik">Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„</h2>
                            <textarea value={inputText} onChange={(e) => setInputText(e.target.value)} className={`w-full h-48 p-6 text-2xl font-bold font-rubik text-right text-gray-800 dark:text-gray-100 bg-gray-50 dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 rounded-3xl outline-none focus:border-${themeColor}-500 focus:bg-white dark:focus:bg-gray-800 transition-all resize-none shadow-inner`} placeholder="Ù…Ø«Ø§Ù„: Ø°Ù‡Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©Ù..." dir="rtl" autoFocus></textarea>
                            {error && <div className="bg-red-50 text-red-500 p-4 rounded-2xl mt-4 font-bold font-rubik text-center border-2 border-red-100">{error}</div>}
                            <div className="mt-auto pt-6">
                            {loading ? (
                                <div className="w-full py-4 bg-gray-50 dark:bg-gray-800 rounded-2xl flex items-center justify-center gap-3 text-gray-400 animate-pulse border-2 border-gray-100 dark:border-gray-700">
                                <div className={`w-6 h-6 border-4 border-gray-200 border-t-${themeColor}-500 rounded-full animate-spin`}></div>
                                <span className="font-black font-rubik">Ø¬Ø§Ø±Ù Ø§Ù„ØµÙ†Ø¯Ù‚Ø©...</span>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                <Button3D onClick={handleAnalyze} disabled={!inputText.trim()} color={themeColor}><span>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¢Ù†</span></Button3D>
                                <button onClick={() => setView('home')} className="w-full py-3 text-gray-400 font-bold font-rubik hover:text-gray-600 transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
                                </div>
                            )}
                            </div>
                        </motion.div>
                        )}

                        {view === 'result' && result && (
                        <motion.div key="result" initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="h-full flex flex-col bg-gray-50 dark:bg-gray-900 overflow-hidden relative">
                            <div className="flex-1 overflow-auto p-4 flex flex-col items-start bg-gray-50/50 dark:bg-gray-900/50 backdrop-blur-sm">
                                <div ref={chartRef} className="inline-block min-w-min p-2 pb-24 mx-auto">
                                <SandaqaChart node={result.root} themeColor={themeColor} forcePrintMode={forcePrintMode} isDarkMode={darkMode} />
                                </div>
                            </div>
                            
                            <AnimatePresence>
                            {showExportMenu && (
                                <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 20 }} className="fixed bottom-24 left-4 right-4 z-40">
                                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700 p-2 flex flex-col gap-2 max-w-sm mx-auto">
                                    <button onClick={() => handleExport('png')} className="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-right">
                                    <div className={`bg-${themeColor}-100 dark:bg-${themeColor}-900/50 p-2 rounded-lg text-${themeColor}-600 dark:text-${themeColor}-400`}><Icons.Image /></div>
                                    <div className="flex flex-col items-start"><span className="font-bold text-gray-800 dark:text-gray-200 font-rubik">ØµÙˆØ±Ø© (PNG)</span><span className="text-xs text-gray-500 font-rubik">Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©</span></div>
                                    </button>
                                    <button onClick={() => handleExport('pdf')} className="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-right">
                                    <div className="bg-red-100 dark:bg-red-900/50 p-2 rounded-lg text-red-600 dark:text-red-400"><Icons.PDF /></div>
                                    <div className="flex flex-col items-start"><span className="font-bold text-gray-800 dark:text-gray-200 font-rubik">Ù…Ù„Ù (PDF)</span><span className="text-xs text-gray-500 font-rubik">Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</span></div>
                                    </button>
                                </div>
                                </motion.div>
                            )}
                            </AnimatePresence>
                            
                            <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/90 dark:bg-gray-900/90 backdrop-blur-lg border-t border-gray-100 dark:border-gray-800 z-30 max-w-md mx-auto flex gap-3 shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                            <Button3D onClick={() => setView('input')} variant="secondary" color={themeColor} className="flex-1">Ø¬Ø¯ÙŠØ¯</Button3D>
                            <Button3D onClick={() => setShowExportMenu(!showExportMenu)} color={themeColor} className="flex-[2]">{showExportMenu ? <span>Ø¥Ù„ØºØ§Ø¡</span> : <><Icons.Download /><span>ØªØµØ¯ÙŠØ± / Ø­ÙØ¸</span></>}</Button3D>
                            </div>
                        </motion.div>
                        )}
                    </AnimatePresence>
                    </div>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>